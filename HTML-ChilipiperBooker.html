//This code is intended to be deployed through Google Tag Manager to pick up on HTML Form Submissions.
//Works with standard HTML forms including WebFlow, WordPress, and custom forms.

<script src="https://js.chilipiper.com/marketing.js" type="text/javascript"></script>

<script>

/******************************************************************************
 * CONFIGURATION - Modify the settings below to match your environment
 ******************************************************************************/

var cpTenantDomain = "CPDomain"; // Your Chili Piper subdomain
var cpRouterName = "CPRouter";   // Your Chili Piper router name

// CSS selector for forms that should trigger Chili Piper
// Examples:
//   "form" - all forms on the page
//   "#contact-form" - form with id="contact-form"
//   ".demo-request-form" - forms with class="demo-request-form"
//   "[data-chilipiper='true']" - forms with data-chilipiper="true" attribute
var formSelector = "form";

// Set to true to push events to Google Tag Manager dataLayer
var enableGTMEvents = true;

// GTM dataLayer event names (customize if needed)
var gtmEvents = {
    onSuccess: 'chilipiper.booking.success',  // Fires after successful booking
    onRouted: 'chilipiper.routed',            // Fires when routing attempt is made
    onClose: 'chilipiper.booking.failed',     // Fires when user closes without booking
    onError: 'chilipiper.booking.error'       // Fires when lead doesn't match queue rules
};

// Optional: Filter which forms trigger Chili Piper
// Return true to submit to Chili Piper, false to skip
// Parameters: values (object with form field values), formEl (the form DOM element)
function shouldSubmitForm(values, formEl) {
    // Examples:
    // Only trigger for specific form: return formEl.id === "demo-form";
    // Only trigger if email contains company domain: return values.email && !values.email.includes("@yourcompany.com");
    // Only trigger for demo requests: return formEl.classList.contains("demo-request");
    return true; // Default: submit all matching forms
}

/******************************************************************************
 * DO NOT MODIFY BELOW THIS LINE
 ******************************************************************************/

function pushGTMEvent(eventName) {
    if (enableGTMEvents && typeof dataLayer !== 'undefined') {
        dataLayer.push({'event': eventName});
    }
}

function getFormValues(formEl) {
    var values = {};
    var formData = new FormData(formEl);

    formData.forEach(function(value, key) {
        // Handle multiple values (e.g., checkboxes) by converting to array
        if (values[key]) {
            if (!Array.isArray(values[key])) {
                values[key] = [values[key]];
            }
            values[key].push(value);
        } else {
            values[key] = value;
        }
    });

    return values;
}

function handleFormSubmit(event) {
    var formEl = event.target;
    if (!formEl || formEl.tagName !== 'FORM') return;

    // Check if form matches our selector
    if (!formEl.matches(formSelector)) return;

    var values = getFormValues(formEl);

    if (!shouldSubmitForm(values, formEl)) return;

    if (typeof ChiliPiper === 'undefined') {
        console.warn('ChiliPiper not loaded');
        return;
    }

    // Prevent default form submission
    event.preventDefault();

    ChiliPiper.submit(cpTenantDomain, cpRouterName, {
        trigger: 'ThirdPartyForm',
        lead: values,
        onSuccess: function() { pushGTMEvent(gtmEvents.onSuccess); },
        onRouted: function() { pushGTMEvent(gtmEvents.onRouted); },
        onClose: function() { pushGTMEvent(gtmEvents.onClose); },
        onError: function() { pushGTMEvent(gtmEvents.onError); }
    });
}

// Use event delegation to capture all form submissions
document.addEventListener('submit', handleFormSubmit, true);
</script>
