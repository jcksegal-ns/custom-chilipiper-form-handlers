//You can either add this script to Google Tag Manager and trigger it to load on any page with a Marketo form
//Or you can add your Marketo Form Embed code between the two script tags.

<script src="https://js.chilipiper.com/marketing.js" type="text/javascript"></script>

//Add your Marketo form embed code here if not deploying through Google Tag Manager.

<script>

/******************************************************************************
 * CONFIGURATION - Modify the settings below to match your environment
 ******************************************************************************/

var cpTenantDomain = "CPDomain"; // Your Chili Piper subdomain
var cpRouterName = "CPRouter";   // Your Chili Piper router name

// Set to true to push events to Google Tag Manager dataLayer
var enableGTMEvents = true;

// GTM dataLayer event names (customize if needed)
var gtmEvents = {
    onSuccess: 'chilipiper.booking.success',  // Fires after successful booking
    onRouted: 'chilipiper.routed',            // Fires when routing attempt is made
    onClose: 'chilipiper.booking.failed',     // Fires when user closes without booking
    onError: 'chilipiper.booking.error'       // Fires when lead doesn't match queue rules
};

// Optional: Filter which forms trigger Chili Piper
// Return true to submit to Chili Piper, false to skip
// Parameters: values (object with form field values), formId (Marketo form ID)
function shouldSubmitForm(values, formId) {
    // Examples:
    // Only trigger for specific form: return formId === 1234;
    // Only trigger if email contains company domain: return values.Email && !values.Email.includes("@yourcompany.com");
    // Only trigger for demo requests: return values.Form_Type === "demo_request";
    return true; // Default: submit all forms
}

/******************************************************************************
 * DO NOT MODIFY BELOW THIS LINE
 ******************************************************************************/

function pushGTMEvent(eventName) {
    if (enableGTMEvents && typeof dataLayer !== 'undefined') {
        dataLayer.push({'event': eventName});
    }
}

function handleMarketoForm(form) {
    form.onSuccess(function(values) {
        var formId = form.getId();

        if (!shouldSubmitForm(values, formId)) return false;

        if (typeof ChiliPiper === 'undefined') {
            console.warn('ChiliPiper not loaded');
            return false;
        }

        ChiliPiper.submit(cpTenantDomain, cpRouterName, {
            trigger: 'ThirdPartyForm',
            lead: values,
            onSuccess: function() { pushGTMEvent(gtmEvents.onSuccess); },
            onRouted: function() { pushGTMEvent(gtmEvents.onRouted); },
            onClose: function() { pushGTMEvent(gtmEvents.onClose); },
            onError: function() { pushGTMEvent(gtmEvents.onError); }
        });
        return false;
    });
}

function initChiliPiperMarketo() {
    if (initChiliPiperMarketo.done) return;

    if (typeof MktoForms2 !== 'object') {
        document.addEventListener('load', initChiliPiperMarketo, true);
        return;
    }

    document.removeEventListener('load', initChiliPiperMarketo, true);
    initChiliPiperMarketo.done = true;

    MktoForms2.whenReady(handleMarketoForm);
}

initChiliPiperMarketo();
</script>
